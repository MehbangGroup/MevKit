/* Includes ------------------------------------------------------------------*/
#include "display.h"

/* Private constants ---------------------------------------------------------*/
const uint8_t AsciiTable[128] = {
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
  0x00,0x00,0x00,0x00,0x00,0x02,0x20,0x00,0xDD,0x09,
  0xD3,0x9B,0x0F,0x9E,0xDE,0x19,0xDF,0x9F,0x00,0x00,
  0x00,0x82,0x00,0x00,0x00,0x5F,0xCE,0xC2,0xCB,0xD6,
  0x56,0x9F,0x4E,0x40,0x89,0x5E,0xC4,0x4B,0x4A,0xCA,
  0x57,0x1F,0x42,0x9E,0xC6,0xC8,0xCD,0xCF,0x4F,0x8F,
  0x43,0x00,0x00,0x00,0x00,0x80,0x00,0x5F,0xCE,0xC2,
  0xCB,0xD6,0x56,0x9F,0x4E,0x40,0x89,0x5E,0xC4,0x4B,
  0x4A,0xCA,0x57,0x1F,0x42,0x9E,0xC6,0xC8,0xCD,0xCF,
  0x4F,0x8F,0x43,0x00,0x00,0x00,0x00,0x00
};

const uint8_t SegmentMultiplex[4] = {
  0x70, 0xB0, 0xD0, 0xE0
};

/* Private variables ---------------------------------------------------------*/
volatile uint8_t LEDs = 0x0F;
volatile uint8_t Segments[4] = { 0 };

/* Private functions ---------------------------------------------------------*/
static inline void ShiftOut(uint32_t data)
{
  ClrLAT();
  for (int i = 0; i < 16; i++)
  {
    ClrCLK();
    if (data & 0x8000) SetSDI(); else ClrSDI();
    data <<= 1;
    SetCLK();
  }
  SetLAT();
}

/* Exported functions ------------------------------------------------------- */
void DisplayRun(void)
{
  static unsigned int index = 0;
  index = index == 3 ? 0 : index + 1;
  uint32_t data = Segments[index] << 8 | SegmentMultiplex[index] | LEDs;
  ShiftOut(data);
}

void DisplayString(char* text)
{
  DisplayStringWithDP(text, DP_N);
}

void DisplayStringWithDP(char* text, int dpLoc)
{
  for (int i = 0; i < 4; i++)
  {
    if (*text == '\0')
    {
      Segments[i] = 0;
      continue;
    }
    uint8_t dp = (dpLoc == i || *(text+1) == '.') ? AsciiTable['.'] : 0x00;
    Segments[i] = AsciiTable[*text] | dp;
    if(*text != '.' && *(text+1) == '.') text++;
    text++;
  }
}

void DisplayNumber(int num)
{
  char str[] = "0000";
  for (int i = 0; num > 0; i++)
  {
    str[3 - i] += num % 10;
    num /= 10;
  }
  DisplayString(str);
}

void DisplayLed(int led, int state)
{
  if (LED_BR <= led && led <= LED_UL)
  {
    if (state)
      LEDs |= 1 << led;
    else
      LEDs &= 0x0F & ~(1 << led);
  }
}
